---
title: "Imagine"
author: 
date: 
output: 
  html_document
runtime: shiny
css: imagine_style.css
---
<style>
body {
    position: absolute;
    left: 0px;}
</style>

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)

library(rethinking)
library(dplyr)
library(tidyr)

library(shinythemes, quietly =  TRUE)

library(BEST) # for posterior plot

# pirate plots
# install.packages("devtools") # Only if you don't have the devtools library already installed
   # library("devtools")
   # install_github("ndphillips/yarrr")

# library(yarrr)

options(digits = 3)
options(xtable.include.rownames=F)
```


```{r assumptions}


fluidPage(theme = shinytheme("flatly"), 
inputPanel(

  sliderInput("num_districts", label = "Number of districts",
              min = 2, max = 60, value = 2, step = 1),
  
  sliderInput("n_clinics", label = "Number of clinics",
              min = 2, max = 40, value = 10, step = 2),
  
  sliderInput("mean_population", label = "Average clinic catchment size",
              min = 1000, max = 10000, value = 2500, step = 500),
  
  sliderInput("bkrd_mean_incidence", label = "Average incidence per annum",
              min = .01, max = 1, value = .1, step = .1),
  
  sliderInput("case.sensitivity", label = "Case detection sensitivity",
              min = .01, max = 1, value = .6, step = .1),
  
   sliderInput("case.specificity", label = "Case detection specifiicty",
              min = .01, max = 1, value = .6, step = .1),

   sliderInput("test.positive.rate", label = "Test positive rate",
              min = .01, max = 1, value = .6, step = .1),
  
  sliderInput("reporting.fidelity", label = "Reporting fidelity",
              min = .01, max = 1, value = .6, step = .1),
  
  sliderInput("effectiveness", label = "Intervention effectiveness",
              min = 0, max = 1, value = .10, step = .05),
  
   # selectInput("period", label = "Intervention time period",
   #            choices = c("pre", "post"), selected = "post"),
  
    selectInput("randomize", label = "Intervention randomized by",
              choices = c("clinic", "district"), selected = "clinic"),
  
  actionButton("goButton", "Each press creates a trial",
               width = "100%"),

  actionButton("reset", "Clear")
  # ,
  # 
  # actionButton("run", "Create a long run")
   
) 
, style='width: 1500px;'
)


```

```{r functions}

source('imagine_clinics_disease.R')

```

```{r data}
# DATA

c = reactive({
   if( input$goButton > 0){
      
   clinics(
           randomize = input$randomize,
           num_districts = input$num_districts  ,
           n_clinics = input$n_clinics  , 
           mean_population = input$mean_population 
           )
      }
})

d = reactive({
   if( input$goButton > 0){
   disease(
           clinic_list = c(),
           bkrd_mean_incidence = input$bkrd_mean_incidence  ,
           case.sensitivity = input$case.sensitivity ,
           case.specificity = input$case.specificity ,
           test.positive.rate =  input$test.positive.rate ,
           reporting.fidelity = input$reporting.fidelity, 
           effectiveness = input$effectiveness
           # period = input$period
           )
   }
})

eff = reactive({  effect( d = d(), randomize = input$randomize ) })

# initialize stored results for single runs...
values <- reactiveValues(df_data = NULL)

observeEvent(input$reset, {
    values$df_data <- NULL
  })  

df = reactive({
   
   if( input$goButton == 0) return()
   
   temp <- bind_cols(
      data.frame( interation = input$goButton ) ,
      as.data.frame( t(quantile(eff(), probs = seq(.025, .975, .475) )) )
   )
   
   if( input$goButton == 1 ){

      values$df_data <- temp

   } else {

      temp2 = isolate(values$df_data)
      values$df_data <- bind_rows( temp2 , temp )
   }
   
   return( values$df_data )
  })

# calculate long run data set 
long_run_data = reactive({ 

      if( input$goButton == 0) return()
   
      withProgress(message = 'Making plot', value = 0, {
      # Number of times we'll go through the loop

      runs = 100

      for ( i in 1:runs){

            c = clinics(
                 randomize = input$randomize,
                 num_districts = input$num_districts  ,
                 n_clinics = input$n_clinics  ,
                 mean_population = input$mean_population
                 )

            d = disease(
                 clinic_list = c,
                 bkrd_mean_incidence = input$bkrd_mean_incidence  ,
                 case.sensitivity = input$case.sensitivity ,
                 case.specificity = input$case.specificity ,
                 test.positive.rate =  input$test.positive.rate ,
                 reporting.fidelity = input$reporting.fidelity,
                 effectiveness = input$effectiveness
                 # period = input$period
                 )


               # if (input$randomize %in% 'district'){
               # 
               #    m1 = alist(
               #       cases ~ dbinom( population, p ),
               #       logit(p) <- a[district_id] + bt * trt ,
               #       a[district_id] ~ dnorm( 0, 10 ),
               #       bt ~ dnorm( 0 , 10)
               #       )
               # 
               # } 
            
               # same model, fixed intercept, for randomized by clinic or district
                   m1 = alist(
                     cases ~ dbinom( population, p ),
                     logit(p) <- a + bt * trt ,
                     a ~ dnorm( 0, 10 ),
                     bt ~ dnorm( 0 , 10)
                     )


         eff =   map( m1,
                      start=list(a=0, bt=0),
                      data = as.data.frame( d )
                      )

         post <- extract.samples( eff )
         effect = (1 - exp(post$bt)) * 100

      temp <- bind_cols(
         data.frame( interation = i ) ,
         as.data.frame( t(quantile(effect, probs = seq(.025, .975, .475) )) )
      )

      if( i == 1 ){

         df_data <- temp

      } else {

         temp2 = df_data
         df_data <- bind_rows( temp2 , temp )
      }

      }

      return(df_data)

      # Increment the progress bar, and update the detail text.
      incProgress(1/runs, detail = paste("Doing part", i))
      }) # end withProgress

   })

long_run_data_summary = reactive({
    
   if( input$goButton == 0) return() 
   
   s = long_run_data() %>% 
      summarise(
         `% significant` = sum( ifelse( `2.5%`>0 | `97.5%`<0, 1, 0) ),
         `% sig positive` = sum( ifelse( `2.5%`>0 , 1, 0) ),
         `% sig negative` = sum( ifelse( `97.5%`<0, 1, 0) ),
         `mean of medians` = mean( `50%` )
      )
   
   return(s)
})

```


```{r display}
# summarise results
tabsetPanel(

tabPanel("Random Trial", 
fluidRow(
   
column(4, 
 renderPlot({
    
      if( input$goButton == 0) return()
    
      # pirateplot( cases ~ trt , data = d(), main = "Malaria cases at each clinic, by treatment group",
      #             theme.o = 3, point.o = .7, hdi.o = .5, bar.o = 0 )

   plot( cases ~ factor(trt), data = d(),
         main = "Cases by treatment group", theme.o = 3, point.o = .7, hdi.o = .5,
         bar.o = 0 )
   
   #    plot( population ~ factor(trt), data = d(),
#          main = "Population by treatment group", theme.o = 3, point.o = .7, hdi.o = .6,
#          bar.o = 0)

   })
),

column(4, 
renderTable({

   if( input$goButton == 0) return()

   # d() %>% summarise( n_clinics = n() )
  d() %>% group_by(trt) %>% summarise( `Mean cases`= mean(cases))

}),

renderPlot({

   if( input$goButton == 0) return()

   plotPost( eff() )

}

)

 ),

column(4,
 renderPlot({

      if( input$goButton == 0) return()

     # df()
     
    ggplot( df() , aes( x = `50%`, y = interation )) +
    geom_point(size=5, shape=18) +
    geom_errorbarh(aes(xmax = `97.5%`, xmin = `2.5%`), height = 0.15) +
    geom_vline(xintercept = 0, linetype = "longdash") +
    labs(x="Estimated effectiveness", y="")
    
   })
)

, style='width: 1200px;')
),

tabPanel("Example dataset", 
         renderTable( d()  )
) ,

tabPanel("Long Run", id = "longrun", 
         

   renderPlot({
      
   if( input$goButton == 0) return()

    ggplot( long_run_data() %>% arrange(-`50%`) %>% mutate( order = row_number()),
            aes( x = `50%`, y = order )) +
    geom_point(size=3, shape=18) +
    geom_errorbarh(aes(xmax = `97.5%`, xmin = `2.5%`), height = 0.15) +
    geom_vline(xintercept = 0, linetype = "longdash") +
    geom_vline(xintercept = input$effectiveness * 100, color = "green") +
    labs(x="Estimated effectiveness (median and 95% credible interval)", y="")


    }),
   
   renderTable( long_run_data_summary() )
   ),

tabPanel("Equations", 
         
         renderText({ "coming soon" })
         
         ),

tabPanel("Explanations",
         
         includeMarkdown("imagine_explanations.md")

)
)
         
```